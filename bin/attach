#!/usr/bin/env bash
set -e

prog="$(basename $0)"
session='main'

if [[ -n "$TMUX" ]]; then
    echo "error: already attached to a tmux session"
    exit 2
fi

if [[ -n "$1" && "$1" != -* ]]; then
    session="$1"
    shift
fi

# set up symlink to ssh-agent socket
if [[ -n "$SSH_AUTH_SOCK" ]]; then
    ln -sfn "$SSH_AUTH_SOCK" "$HOME/.ssh_auth_sock_$session"
    export OLD_SSH_AUTH_SOCK="$SSH_AUTH_SOCK"
    export SSH_AUTH_SOCK="$HOME/.ssh_auth_sock_$session"
fi

if ! tmux ls -F '#S' 2>/dev/null | grep -q "$session"; then
    tmux new-session -d -s "$session"
fi

tmux "$@" attach-session -d -t "$session"

# clean up ssh auth sock symlink
if [[ -e "$HOME/.ssh_auth_sock_$session" ]]; then
    export SSH_AUTH_SOCK="$OLD_SSH_AUTH_SOCK"
    unset OLD_SSH_AUTH_SOCK
    rm "$HOME/.ssh_auth_sock_$session"
fi
