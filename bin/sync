#!/usr/bin/env bash
set -e

usage () {
    echo "$0 pull FROM [rsync options]"
    echo "$0 push TO [rsync options]"
}

interactive_merge() {
    local src="$1"
    local dst="$2"

    if [[ -f "${src}" ]] && ! diff -q "${dst}" "${src}"; then
        vimdiff "${dst}" "${src}"
    elif [[ -d "${src}" ]]; then
        [[ ! -d "${dst}" ]] && mkdir -pv "${dst}"
        for i in ${src}/*; do
            interactive_merge "${i}" "${dst}/$(basename "${i}")"
        done
    fi
}

main() {
    local cwd=
    local dst=
    local globstar=
    local mode=
    local src=
    local target=

    mode="$1"
    shift || (usage; exit 1)

    target="$1"
    shift || (usage; exit 1)

    cwd="$(pwd)"

    case "${mode}" in
        pull)
            src="${target}"
            dst="${cwd}"
            interactive_merge "${src}" "${dst}"
            ;;
        push)
            src="${cwd}"
            dst="${target}"
            # don't interactive merge when dst does not exist
            if [[ -d "${dst}" ]]; then
                interactive_merge "${src}" "${dst}"
            fi

            # rsync the rest
            rsync_args="-acv --delete --exclude-from=${src}/.rsyncignore $@ ${src}/ ${dst}"
            rsync --dry-run ${rsync_args}
            local response=
            read -p "Accept these changes? [y/N] " response
            if [[ "${response}" =~ [yY]([eE][sS])? ]]; then
                rsync ${rsync_args}
                [[ -f ~/dotfiles/ssh/config ]] && chmod 0600 ~/dotfiles/ssh/config
            fi
            ;;
        *)
            usage
            exit 1
            ;;
    esac
}

main "$@"
