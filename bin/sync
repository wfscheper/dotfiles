#!/usr/bin/env bash
set -e

usage () {
    echo "$0 pull FROM"
    echo "$0 push TO"
}

main() {
    local cwd=
    local dst=
    local globstar=
    local mode=
    local src=
    local target=

    mode="$1"
    shift || (usage; exit 1)

    target="$1"
    shift || (usage; exit 1)

    cwd="$(pwd)"

    case "${mode}" in
        pull)
            src="${target}"
            dst="${cwd}"
            ;;
        push)
            src="${cwd}"
            dst="${target}"
            ;;
        *)
            usage
            exit 1
            ;;
    esac

    # turn on globstar
    if ! shopt -q globstar; then
        globstar=1
        shopt -s globstar
    fi

    for file in _* install.sh bin/attach config/*/** ssh/** _vim/*/**; do
        if [[ -f "${file}" ]] && ! diff -q "${src}/${file}" "${dst}/${file}"
        then
            vimdiff "${dst}/${file}" "${src}/${file}"
        fi
    done

    if [[ -n "${globstar}" ]]; then
        shopt -u globstar
    fi

    rsync -acvn "$@" \
        --exclude='/.git*' \
        --exclude='/bin/sync' \
        --exclude='/_vim/dein' \
        --exclude='/config/fish/fish_history' \
        --exclude='/config/fish/fishd.*' \
        "${src}/_bash_it" \
        "${src}/_pyenv" \
        "${src}/_zbin" \
        "${dst}"
    local response=
    read -p "Accept these changes? [y/N] " response
    if [[ "${response}" =~ [yY]([eE][sS])? ]]; then
        rsync -acv "$@" \
            --exclude='/.git*' \
            --exclude='/bin/sync' \
            --exclude='/_vim/dein' \
            --exclude='/config/fish/fish_history' \
            --exclude='/config/fish/fishd.*' \
            "${src}/_bash_it" \
            "${src}/_pyenv" \
            "${src}/_zbin" \
            "${dst}"
        chmod 0600 ~/.ssh/config
    fi
}

main "$@"
