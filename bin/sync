#!/bin/bash
set -e

usage () {
    echo "$0 pull FROM"
    echo "$0 push TO"
}

main() {
    local mode=
    mode="$1"
    shift || (usage; exit 1)

    local dest=
    dest="$1"
    shift || (usage; exit 1)

    local cwd=
    cwd="$(pwd)"

    case "${mode}" in
        pull)
            src="${dest}/"
            dst="$(pwd)"
            diff -qr "${dest}" "${cwd}" | egrep -v "^Only in ${dest}"
            ;;
        push)
            src="$(pwd)/"
            dst="${dest}"
            diff -ur "${dest}" "${cwd}" | egrep -v "^Only in ${dest}"
            local response=
            read -p "Accept these changes? [y/N] " response
            if [[ "${response}" =~ [yY]([eE][sS])? ]]; then
                rsync -acv --exclude='/.git*' --exclude='/bin/sync' "$@" \
                    "${cwd}/" "${dest}"
                chmod 0600 ~/.ssh/config
            fi
            ;;
        *)
            usage
            exit 1
            ;;
    esac
}

main "$@"
