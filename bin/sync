#!/bin/bash
set -e

usage () {
    echo "$0 pull FROM"
    echo "$0 push TO"
}

MODE=$1
shift || (usage; exit 1)

DEST=$1
shift || (usage; exit 1)

case $MODE in
    pull)
        src="${DEST}/"
        dst="$(pwd)"
        ;;
    push)
        src="$(pwd)/"
        dst="${DEST}"
        ;;
    *)
        usage
        exit 1
        ;;
esac

diff -ur ${dst} ${src} | egrep -v "^Only in (${src}|${dst})" | less
read -p "Accept these changes? [y/N] " RESPONSE
if [[ "${RESPONSE}" = "y" || "${RESPONSE}" = "Y" ]]; then
    rsync -acv --exclude='/.git*' --exclude='/bin/sync' "$@" ${src} ${dst}
    chmod 0600 ~/.ssh/config
fi
